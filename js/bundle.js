const log=require("@jasonfleischer/log");const pianoKit=require("@jasonfleischer/piano");const fretboardKit=require("@jasonfleischer/fretboard");const musicKit=require("@jasonfleischer/music-model-kit");musicKit.init();$=function(id){return document.getElementById(id)};var isSafari=navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&navigator.userAgent.indexOf("CriOS")==-1&&navigator.userAgent.indexOf("FxiOS")==-1;window.mobileCheck=function(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};window.mobileAndTabletCheck=function(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};function isFromHomeScreen(){const params=new URLSearchParams(window.location.search);return params.has("from")}function randomInteger(min,max){return Math.floor(Math.random()*(max-min+1)+min)}function getAverage(numberArray){let sum=0;var i;for(i=0;i<numberArray.length;i++){sum+=numberArray[i]}return sum/numberArray.length}model={selected_root_note:0,selected_scale_type:"",threshold:.1};storage={};storage.load=function(){model.selected_root_note=storage.getSelectedNote(60);model.selected_scale_type=storage.getSelectedScaleType("Major pentatonic")};storage.SELECTED_NOTE="SING_SELECTED_NOTE";storage.getSelectedNote=function(default_value){return storage.get(storage.SELECTED_NOTE,default_value)};storage.setSelectedNote=function(value){localStorage.setItem(storage.SELECTED_NOTE,value)};storage.SELECTED_SCALE_TYPE="SING_SELECTED_SCALE_TYPE";storage.getSelectedScaleType=function(default_value){return storage.get(storage.SELECTED_SCALE_TYPE,default_value)};storage.setSelectedScaleType=function(value){localStorage.setItem(storage.SELECTED_SCALE_TYPE,value)};storage.get=function(key,default_value){let result=localStorage.getItem(key);return result==undefined?default_value:result};alert={};alert.init=function(){$("alert_container").addEventListener("click",function(event){alert.dismiss()});$("dismiss_alert_button").addEventListener("click",function(event){alert.dismiss()});$("alert").addEventListener("click",function(event){event.stopPropagation();return false})};alert.show=function(title,contents){$("alert_title").innerHTML=title;$("alert_contents").innerHTML=contents;$("alert_container").style.display="block"};alert.dismiss=function(){$("alert_container").style.display="none"};information={};information.showAlert=function(){let contents=`
		<p onclick="openMailToDeveloper()">Thank you for using this website. If you wish to submit feedback, comment or report an error click <strong>here</strong>.</p>
		<p onclick="openURL('https://jasonfleischer.github.io/website/');">Information about the developer can be found <strong>here</strong>.</p>`;alert.show("Information",contents)};information.dismissAlert=function(){alert.dismiss()};openURL=function(url){window.open(url,"_blank")};openMailToDeveloper=function(){var subject="Synth Website Feedback";subject=subject.replaceAll(" ","%20");openURL("mailto:jason_fleischer@hotmail.ca?Subject="+subject)};const tuner={FFT_SIZE:2048,USER_MEDIA_CONSTRAINTS:{audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},NOTES:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],CONCERT_PITCH:440,MIDI:69,A:2**(1/12),C0_PITCH:16.35,THRES:.2};tuner.autoCorrelate=(buf,sampleRate)=>{const RMS=Math.sqrt(buf.reduce((acc,el)=>acc+el**2,0)/buf.length);if(RMS<.001)return NaN;let r1=0;let r2=buf.length-1;for(let i=0;i<buf.length/2;++i){if(Math.abs(buf[i])<tuner.THRES){r1=i;break}}for(let i=1;i<buf.length/2;++i){if(Math.abs(buf[buf.length-i])<tuner.THRES){r2=buf.length-i;break}}const buf2=buf.slice(r1,r2);const c=new Array(buf2.length).fill(0);for(let i=0;i<buf2.length;++i){for(let j=0;j<buf2.length-i;++j){c[i]=c[i]+buf2[j]*buf2[j+i]}}let d=0;for(;c[d]>c[d+1];++d);let maxval=-1;let maxpos=-1;for(let i=d;i<buf2.length;++i){if(c[i]>maxval){maxval=c[i];maxpos=i}}let T0=maxpos;let x1=c[T0-1];let x2=c[T0];let x3=c[T0+1];let a=(x1+x3-2*x2)/2;let b=(x3-x1)/2;return sampleRate/(a?T0-b/(2*a):T0)};tuner.getDataFromFrequency=frequency=>{const N=Math.round(12*Math.log2(frequency/tuner.CONCERT_PITCH));const Fn=tuner.CONCERT_PITCH*tuner.A**N;const noteIndex=(N+tuner.MIDI)%12;const octave=Math.floor(Math.log2(Fn/tuner.C0_PITCH));var cents=tuner.calculateCents(frequency,Fn);cents=tuner.adjustCentsError(cents,tuner.NOTES[noteIndex],octave);return{frequency:frequency,note:tuner.NOTES[noteIndex],noteFrequency:Fn,deviation:frequency-Fn,cents:cents,octave:octave}};tuner.getAverageVolume=buf=>{let sum=0;for(let i=0;i<buf.length;++i){sum+=Math.abs(buf[i])}return Math.sqrt(sum/buf.length)};tuner.calculateCents=(f1,f2)=>{if(f1===undefined||f2===undefined){return undefined}return Math.floor(1200*Math.log(f1/f2)/Math.log(2))};tuner.errorMap={0:{A:0,"A#":0,B:0},1:{C:0,"C#":0,D:0,"D#":0,E:0,F:0,"F#":0,G:0,"G#":0,A:0,"A#":0,B:0},2:{C:0,"C#":0,D:0,"D#":0,E:0,F:0,"F#":0,G:0,"G#":0,A:0,"A#":0,B:0},3:{C:0,"C#":0,D:-5,"D#":0,E:-3,F:-2,"F#":0,G:-2,"G#":0,A:-1,"A#":0,B:-1},4:{C:-8,"C#":0,D:-7,"D#":0,E:-4,F:-5,"F#":0,G:-4,"G#":0,A:-3,"A#":0,B:-3},5:{C:-3,"C#":0,D:0,"D#":0,E:0,F:0,"F#":0,G:0,"G#":0,A:0,"A#":0,B:0},6:{C:0,"C#":0,D:0,"D#":0,E:0,F:0,"F#":0,G:0,"G#":0,A:0,"A#":0,B:0},7:{C:0,"C#":0,D:0,"D#":0,E:0,F:0,"F#":0,G:0,"G#":0,A:0,"A#":0,B:0},8:{C:0}};tuner.adjustCentsError=(cents,note,octave)=>{return cents};tuner.setup=async()=>{let rafID;let audioContext;let analyser;let callbacks=[];const init=async()=>{const stream=await navigator.mediaDevices.getUserMedia(tuner.USER_MEDIA_CONSTRAINTS);audioContext=new AudioContext;analyser=audioContext.createAnalyser();analyser.fftSize=tuner.FFT_SIZE;analyser.smoothingTimeConstant=.8;audioContext.createMediaStreamSource(stream).connect(analyser)};const update=()=>{const buffer=new Float32Array(tuner.FFT_SIZE);analyser.getFloatTimeDomainData(buffer);const frequency=tuner.autoCorrelate(buffer,audioContext.sampleRate);const averageVolume=tuner.getAverageVolume(buffer);let data=frequency?tuner.getDataFromFrequency(frequency):{};data.volume=averageVolume;callbacks.forEach(fn=>fn(data));rafID=requestAnimationFrame(update)};await init();return{start:()=>update(),stop:()=>cancelAnimationFrame(rafID),subscribe:fn=>callbacks=[...callbacks,fn],unsubscribe:fn=>callbacks=callbacks.filter(el=>el!==fn)}};class CentsView{constructor(id="cents_view_id",width=1e3){this.id=id;this.WIDTH=1e3;this.HEIGHT=30;this.root_view=document.getElementById(this.id);this.root_view.style.position="relative";this.root_view.style.width=this.WIDTH+"px";this.root_view.style.height=this.HEIGHT+"px";this.root_view.width=this.WIDTH;this.root_view.height=this.HEIGHT;this.canvas=this.buildCanvas("cents_canvas_"+this.id);this.drawing_canvas=this.buildCanvas("cents_drawing_canvas_"+this.id);this.draw();this.resize(width)}buildCanvas(id){let canvas=document.createElement("canvas");canvas.id=id;canvas.style.position="absolute";canvas.style.left="0px";canvas.style.right="0px";canvas.style.width=this.WIDTH+"px";canvas.style.height=this.HEIGHT+"px";canvas.width=this.WIDTH;canvas.height=this.HEIGHT;this.root_view.appendChild(canvas);return canvas}resize(newWidth){var newWidth=Math.min(newWidth,this.WIDTH);let newHeight=newWidth*(this.HEIGHT/this.WIDTH);let views=[this.root_view,this.canvas,this.drawing_canvas];for(let i=0;i<views.length;i++){let view=views[i];view.style.height=newHeight+"px";view.style.width=newWidth+"px"}}draw(){let canvas=this.canvas;let ctx=canvas.getContext("2d");let number_of_cents=100;let spacing=this.WIDTH/100;let xPosition=0;for(let i=0;i<=number_of_cents;i++){ctx.beginPath();ctx.strokeStyle=this.getLineColor(i-50);ctx.lineWidth=1;let dividerHeight=i%10==0?0:this.HEIGHT*.4;ctx.moveTo(xPosition,dividerHeight);ctx.lineTo(xPosition,this.HEIGHT);ctx.stroke();xPosition+=spacing}this.drawTriangle()}drawCents(cents,color="#00f"){let ctx=this.drawing_canvas.getContext("2d");ctx.clearRect(0,0,this.WIDTH,this.HEIGHT);ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=3;let x=(cents+50)/100*this.WIDTH;ctx.moveTo(x,0);ctx.lineTo(x,this.HEIGHT);ctx.stroke()}getLineColor(cents){let number=Math.max(0,parseInt(255*((50-Math.abs(cents))/50)));var valueHexStr=number.toString(16);if(valueHexStr.length<2){valueHexStr="0"+valueHexStr}return"#"+valueHexStr+valueHexStr+valueHexStr}drawTriangle(){let ctx=this.canvas.getContext("2d");ctx.beginPath();ctx.fillStyle="#ddd";let x=this.WIDTH*.5;let size=this.HEIGHT*.3;ctx.moveTo(x,size);ctx.lineTo(x+size,0);ctx.lineTo(x-size,0);ctx.lineTo(x,size);ctx.closePath();ctx.fill()}}class TunerView{constructor(id="tuner_view_id",width=1e3,range=musicKit.piano_range){this.id=id;this.min_midi_value=range.min;this.max_midi_value=range.max;this.WIDTH=1e3;this.HEIGHT=30;this.root_view=document.getElementById(this.id);this.root_view.style.position="relative";this.root_view.style.width=this.WIDTH+"px";this.root_view.style.height=this.HEIGHT+"px";this.root_view.width=this.WIDTH;this.root_view.height=this.HEIGHT;this.canvas=this.buildCanvas("tuner_canvas_"+this.id);this.draw();this.resize(width)}buildCanvas(id){let canvas=document.createElement("canvas");canvas.id=id;canvas.style.position="absolute";canvas.style.left="0px";canvas.style.right="0px";canvas.style.width=this.WIDTH+"px";canvas.style.height=this.HEIGHT+"px";canvas.width=this.WIDTH;canvas.height=this.HEIGHT;this.root_view.appendChild(canvas);return canvas}resize(newWidth){var newWidth=Math.min(newWidth,this.WIDTH);let newHeight=newWidth*(this.HEIGHT/this.WIDTH);let views=[this.root_view,this.canvas];for(let i=0;i<views.length;i++){let view=views[i];view.style.height=newHeight+"px";view.style.width=newWidth+"px"}}draw(frequency=261.63){let ctx=this.canvas.getContext("2d");ctx.clearRect(0,0,this.WIDTH,this.HEIGHT);ctx.beginPath();ctx.lineWidth=2;ctx.fillStyle="#000";ctx.strokeStyle="#333";ctx.rect(0,0,this.WIDTH,this.HEIGHT);ctx.fill();ctx.stroke();let spacing=this.WIDTH*.1;let min_frequency=musicKit.all_notes[this.min_midi_value].frequency;let max_frequency=musicKit.all_notes[this.max_midi_value].frequency;let log2_min_frequency=Math.log2(min_frequency);let percentage=(Math.log2(frequency)-log2_min_frequency)/(Math.log2(max_frequency)-log2_min_frequency);let total_length=spacing*(this.max_midi_value-this.min_midi_value);let offset=this.WIDTH*.5+-1*(percentage*total_length);var xPosition=offset;var i;for(i=this.min_midi_value;i<=this.max_midi_value;i++){if(xPosition<-15||xPosition>this.WIDTH+15){xPosition=xPosition+spacing;continue}var note=musicKit.all_notes[i];ctx.fillStyle="#fff";ctx.font=this.HEIGHT*.8+"px san-serif";ctx.textAlign="center";ctx.fillText(note.note_name.type.substring(0,2),xPosition,this.HEIGHT*.75);xPosition=xPosition+spacing}ctx.beginPath();ctx.strokeStyle="#888";ctx.lineWidth=2;ctx.moveTo(this.WIDTH*.5,0);ctx.lineTo(this.WIDTH*.5,this.HEIGHT);ctx.stroke()}}class VolumeView{constructor(id="volume_view_id",threshold=.2,width=1e3,clip=.9){this.id=id;this.threshold=threshold;this.clip=clip;this.WIDTH=1e3;this.HEIGHT=10;this.root_view=document.getElementById(this.id);this.root_view.style.position="relative";this.root_view.style.width=this.WIDTH+"px";this.root_view.style.height=this.HEIGHT+"px";this.root_view.width=this.WIDTH;this.root_view.height=this.HEIGHT;this.canvas=this.buildCanvas("volume_canvas_"+this.id);this.drawing_canvas=this.buildCanvas("volume_drawing_canvas_"+this.id);this.threshold_canvas=this.buildCanvas("volume_drawing_canvas_"+this.id);this.draw();this.resize(width)}buildCanvas(id){let canvas=document.createElement("canvas");canvas.id=id;canvas.style.position="absolute";canvas.style.left="0px";canvas.style.right="0px";canvas.style.width=this.WIDTH+"px";canvas.style.height=this.HEIGHT+"px";canvas.width=this.WIDTH;canvas.height=this.HEIGHT;this.root_view.appendChild(canvas);return canvas}resize(newWidth){var newWidth=Math.min(newWidth,this.WIDTH);let newHeight=newWidth*(this.HEIGHT/this.WIDTH);let views=[this.root_view,this.canvas,this.drawing_canvas,this.threshold_canvas];for(let i=0;i<views.length;i++){let view=views[i];view.style.height=newHeight+"px";view.style.width=newWidth+"px"}}draw(){let ctx=this.canvas.getContext("2d");ctx.beginPath();ctx.fillStyle="#222";ctx.rect(0,0,this.WIDTH,this.HEIGHT);ctx.fill();this.drawThresholdMarker(this.threshold)}drawVolume(volumePercent){let ctx=this.drawing_canvas.getContext("2d");ctx.clearRect(0,0,this.WIDTH,this.HEIGHT);ctx.beginPath();ctx.fillStyle=this.getBarColor(volumePercent);ctx.lineWidth=2;ctx.rect(0,0,this.WIDTH*volumePercent,this.HEIGHT);ctx.fill()}drawThresholdMarker(threshold){let ctx=this.threshold_canvas.getContext("2d");ctx.clearRect(0,0,this.WIDTH,this.HEIGHT);ctx.beginPath();ctx.fillStyle="#555";let x=this.WIDTH*threshold;ctx.moveTo(x,0);ctx.lineTo(x+this.HEIGHT,this.HEIGHT);ctx.lineTo(x-this.HEIGHT,this.HEIGHT);ctx.lineTo(x,0);ctx.closePath();ctx.fill()}getBarColor(volumePercent){if(volumePercent>=this.clip){return"#f00"}else if(volumePercent<=this.threshold){return"#eee"}else{return"#0f0"}}}class Queue{constructor(){this.items=[]}enqueue(element){this.items.push(element)}dequeue(){if(this.isEmpty())return undefined;return this.items.shift()}peek(){if(this.isEmpty())return undefined;return this.items[0]}isEmpty(){return this.items.length==0}length(){return this.items.length}toArray(){return this.items}}const dronePianoView=pianoKit({id:"drone_piano",onClick:function(note,isOn){log.e("note"+note+" "+isOn);if(isOn){playDrone(note.frequency);let color=note.note_name.is_sharp_or_flat?"#777":"#aaa";dronePianoView.drawNoteWithColor(note,color)}else{stopDrone(note.frequency);dronePianoView.clearNote(note)}},width:1e3,hover:true});var oscillatorsDict=new Map;var compressorNode;const drone={oscillatorsDict:new Map,audioCtx:undefined,masterGainNode:{},compressorNode:{},setup:false,volume:.3};function playDrone(frequency){if(drone.audioCtx==undefined){setupAudioChain()}if(oscillatorsDict.has(frequency)){var osc=oscillatorsDict.get(frequency);if(osc.playing){osc.stop()}oscillatorsDict.delete(frequency)}const oscillator=new Oscillator(drone.audioCtx,frequency,1,"sine");oscillatorsDict.set(frequency,oscillator);oscillator.play()}function setupAudioChain(){drone.audioCtx=new(window.AudioContext||window.webkitAudioContext);compressorNode=drone.audioCtx.createDynamicsCompressor();compressorNode.threshold.setValueAtTime(-20,drone.audioCtx.currentTime);compressorNode.knee.setValueAtTime(40,drone.audioCtx.currentTime);compressorNode.ratio.setValueAtTime(12,drone.audioCtx.currentTime);compressorNode.attack.setValueAtTime(0,drone.audioCtx.currentTime);compressorNode.release.setValueAtTime(.25,drone.audioCtx.currentTime);drone.masterGainNode=drone.audioCtx.createGain();drone.masterGainNode.gain.value=drone.volume;compressorNode.connect(drone.masterGainNode);drone.masterGainNode.connect(drone.audioCtx.destination);oscillatorsDict=new Map;drone.setup=true}function stopDrone(frequency){oscillatorsDict.get(frequency).stop();oscillatorsDict.delete(frequency)}const tunerView=new TunerView("tuner");const tunerView2=new TunerView("tuner2");let tunerObject=undefined;const centsView=new CentsView("cents");const centsView2=new CentsView("cents2");const volumeView=new VolumeView("volume",model.threshold);const pianoView=pianoKit({id:"piano",onClick:function(note,isOn){},hover:true});const fretboardView=fretboardKit({id:"fretboard",onClick:function(note,isOn){logE(note.frequency)},hover:true,showLabels:false,darkMode:true});let average_frequencies=new Queue;let average_cents=new Queue;let average_frequency_length=40;let average_cents_length=40;const callbackExample=data=>{function findNote(noteName,octave){let notes=musicKit.all_notes;var i;for(i=0;i<notes.length;i++){let note=musicKit.all_notes[i];if(note.octave==octave&&note.note_name.type.startsWith(noteName)){return note}}return undefined}function getCentsColor(cents){var c=Math.abs(parseInt(cents));if(c<=10){return"#00ff00"}else if(c>10&&c<25){let number=parseInt(255*((13-(c-11))/13));var greenValueHexStr=number.toString(16);if(greenValueHexStr<10){greenValueHexStr="0"+greenValueHexStr}return"#ff"+greenValueHexStr+"00"}else{return"red"}}if(data.frequency!==undefined){volumeView.drawVolume(data.volume);var note=findNote(data.note,data.octave);if(note!==undefined&&data.volume>model.threshold){average_frequencies.enqueue(data.frequency);average_cents.enqueue(data.cents);var cents=data.cents;let color=getCentsColor(cents);let midiValue=note.midi_value;updateUITuneIndicator(cents,color);$("note").innerHTML=data.note;$("octave").innerHTML=data.octave;centsView.drawCents(cents,color);pianoView.clearHover();pianoView.drawHoverNote(note,color);fretboardView.clearHover();if(midiValue>=musicKit.guitar_range.min&&midiValue<=musicKit.guitar_range.max){fretboardView.drawHoverNote(note,color)}tunerView.draw(data.frequency)}else{}}else{pianoView.clearHover();fretboardView.clearHover();volumeView.drawVolume(0);clearUITuneIndicator()}if(data.volume>model.threshold){if(average_frequencies.length()==average_frequency_length){let frequency=getAverage(average_frequencies.toArray());tunerView2.draw(frequency);average_frequencies.dequeue()}if(average_cents.length()==average_cents_length){let cents=getAverage(average_cents.toArray());let color=getCentsColor(cents);centsView2.drawCents(cents,color);average_cents.dequeue()}}};function startAndSubscribeTuner(){(async function(){try{tunerObject=await tuner.setup();tunerObject.start();tunerObject.subscribe(callbackExample);$("microphone_button").innerHTML="Stop microphone"}catch(error){tunerObject=undefined}})()}startAndSubscribeTuner();kofi=function(){window.open("https://ko-fi.com/jasonfleischer","_blank")};info=function(){information.showAlert()};dismissInfo=function(){information.dismissAlert()};init=function(){storage.load();alert.init();var isSafariMobile=window.mobileAndTabletCheck()&&isSafari;if(isSafariMobile&&!isFromHomeScreen()){install.showAlert()}setupControls();windowResizedEnd();musicKit.changeNoteColors()};function setupControls(){setupNoteTypeSelect();function setupNoteTypeSelect(){var select=$("note_type_select");var i;let noteTypes=musicKit.Note.ALL_NOTE_NAME_TYPES;var midi_value=60;for(i=0;i<noteTypes.length;i++){let noteType=noteTypes[i];let value=noteType.type;var option=document.createElement("option");if(midi_value==model.selected_root_note){option.setAttribute("selected","selected")}option.setAttribute("value",midi_value);midi_value++;option.innerHTML=value;select.appendChild(option)}select.oninput=function(){model.selected_root_note=parseInt(this.value);storage.setSelectedNote(model.selected_root_note);updateUI()};setupThresholdSlider();function setupThresholdSlider(){var slider=$("threshold_range");slider.value=model.threshold;var sliderText=$("threshold");sliderText.innerHTML="Threshold: "+(model.threshold*100).toFixed()+"%";slider.oninput=function(){model.threshold=this.value;sliderText.innerHTML="Threshold: "+(model.threshold*100).toFixed()+"%";volumeView.drawThresholdMarker(model.threshold)}}setupDroneVolumeSlider();function setupDroneVolumeSlider(){var slider=$("drone_volume_range");slider.value=drone.volume*1e3;var sliderText=$("drone_volume");sliderText.innerHTML="Volume: "+(drone.volume*100).toFixed()+"%";slider.oninput=function(){drone.volume=Math.max(1e-5,this.value/1e3);sliderText.innerHTML="Volume: "+(drone.volume*100).toFixed()+"%";if(drone.setup){drone.masterGainNode.gain.setValueAtTime(drone.volume,drone.audioCtx.currentTime)}}}}setupScaleTypeSelect();function setupScaleTypeSelect(){var select=$("scale_type_select");var i;let scaleTypes=musicKit.Scale.TYPE;for(const key in scaleTypes){let value=scaleTypes[key];var option=document.createElement("option");if(value==model.selected_scale_type){option.setAttribute("selected","selected")}option.setAttribute("value",value);option.innerHTML=value;select.appendChild(option)}select.oninput=function(){model.selected_scale_type=this.value;storage.setSelectedScaleType(model.selected_scale_type);updateUI()}}setupRandomButton();function setupRandomButton(){$("random_button").addEventListener("click",function(event){let midiValue=randomInteger(60,71);let note=musicKit.all_notes[midiValue];model.selected_root_note=note.midi_value;let scaleTypes=Object.keys(musicKit.Scale.TYPE).map(function(key){return musicKit.Scale.TYPE[key]});let scale_type=scaleTypes[randomInteger(0,scaleTypes.length-1)];model.selected_scale_type=scale_type;$("note_type_select").value=midiValue;$("scale_type_select").value=scale_type;storage.setSelectedNote(midiValue);storage.setSelectedScaleType(scale_type);updateUI()})}setupClearButton();function setupClearButton(){$("clear_button").addEventListener("click",function(event){pianoView.clear();fretboardView.clear()})}setupMicrophoneButton();function setupMicrophoneButton(){$("microphone_button").addEventListener("click",function(event){if(tunerObject!=undefined){tunerObject.unsubscribe(callbackExample);tunerObject.stop();tunerObject=undefined;$("microphone_button").innerHTML="Start microphone"}else{startAndSubscribeTuner()}})}}var window_resize_start_event_occured=false;var resized_timer;window.onresize=function(){clearTimeout(resized_timer);resized_timer=setTimeout(windowResizedEnd,200);if(!window_resize_start_event_occured){windowResizedStart();window_resize_start_event_occured=true}};function windowResizedStart(){dismissInfo()}function windowResizedEnd(){window_resize_start_event_occured=false;let contentWidth=document.body.clientWidth;let fretboardPaddingLeftRight=34;fretboardView.resize(Math.min(contentWidth-fretboardPaddingLeftRight,1e3));let pianoPaddingLeftRight=30;pianoView.resize(Math.min(contentWidth-pianoPaddingLeftRight,1e3));let tunerPaddingLeftRight=60;tunerView.resize(Math.min(contentWidth-tunerPaddingLeftRight,1e3));tunerView2.resize(Math.min(contentWidth-tunerPaddingLeftRight,1e3));let centsPaddingLeftRight=60;centsView.resize(Math.min(contentWidth-centsPaddingLeftRight,1e3));centsView2.resize(Math.min(contentWidth-centsPaddingLeftRight,1e3));let volumePaddingLeftRight=60;volumeView.resize(Math.min(contentWidth-volumePaddingLeftRight,1e3))}function updateUI(){let note=musicKit.all_notes[model.selected_root_note];let scale=new musicKit.Scale(note,model.selected_scale_type);$("scale_structure").innerHTML=scale.getLabels().toString().replaceAll(","," ");fretboardView.drawScale(scale);pianoView.drawScale(scale)}function updateUITuneIndicator(cents,color){if(cents<=-10){$("flat").style.backgroundColor=color;$("intune").style.backgroundColor="#494949";$("sharp").style.backgroundColor="#494949"}else if(cents>=10){$("flat").style.backgroundColor="#494949";$("intune").style.backgroundColor="#494949";$("sharp").style.backgroundColor=color}else{$("flat").style.backgroundColor="#494949";$("intune").style.backgroundColor=color;$("sharp").style.backgroundColor="#494949"}}function clearUITuneIndicator(){$("flat").style.backgroundColor="#494949";$("intune").style.backgroundColor="#494949";$("sharp").style.backgroundColor="#494949"}Oscillator=class Oscillator{constructor(audioContext,frequency,volume,type){this.audioContext=audioContext;this.oscillator=this.audioContext.createOscillator();this.oscillator.type=type;this.oscillator.frequency.value=frequency;this.gainNode=this.audioContext.createGain();this.gainNode.gain.value=0;this.oscillator.connect(this.gainNode);this.gainNode.connect(compressorNode);this.playing=false;this.volume=volume}play(){if(!this.playing){var time=this.audioContext.currentTime;this.oscillator.start(time);this.gainNode.gain.setValueAtTime(1e-5,time);this.gainNode.gain.exponentialRampToValueAtTime(Math.max(1e-5,this.volume),time+.1);this.playing=true}}stop(delayTime=.5){if(this.playing){var time=this.audioContext.currentTime;this.playing=false;this.gainNode.gain.setValueAtTime(this.volume,time);this.gainNode.gain.exponentialRampToValueAtTime(1e-5,time+delayTime);this.oscillator.stop(time+delayTime+.1)}}setVolume(volume,ramp,rampTime=0){if(this.playing){var time=this.audioContext.currentTime;if(ramp){this.gainNode.gain.setValueAtTime(this.volume,time);this.gainNode.gain.exponentialRampToValueAtTime(volume,time+rampTime);this.volume=volume}else{this.gainNode.gain.setValueAtTime(volume,time)}}}setOscillatorType(type){this.oscillator.type=type}};var install={};let prompt;if("serviceWorker"in navigator){navigator.serviceWorker.register("/sing/service_worker.js",{scope:"/sing/"}).then(function(reg){if(reg.installing){console.log("sing: Service worker installing")}else if(reg.waiting){console.log("sing: Service worker installed")}else if(reg.active){console.log("sing: Service worker active")}}).catch(function(error){console.log("Registration failed with "+error)})}else{console.log("Service worker not available")}window.onload=function(){init()};window.addEventListener("beforeinstallprompt",function(e){e.preventDefault();prompt=e;if(window.mobileAndTabletCheck()){install.showAlert(function(){prompt.prompt()})}});window.addEventListener("appinstalled",async function(e){alert.dismiss()});install.showAlert=function(install_action){let contents=`
		<p>Install this app on your device to easily access it anytime. Installing this app will result in better performance, improved fullscreen experience, and usage without an internet connection.</p>
		<br/>
	`;var isSafariMobile=window.mobileAndTabletCheck()&&isSafari;if(isSafariMobile){contents+=`
			<div id="ios_install_instructions">
				<p>1. Tap on <img src="img/export.png" alt="export"/></p>
				<p>2. Select 'Add to Home Screen'</p>
			</div>`}else{contents+='<button id="install">Install</button>'}alert.show("Install App",contents);if(!isSafariMobile){let installButton=document.getElementById("install");installButton.addEventListener("click",install_action)}};const CACHE_NAME="v1.6";const CACHE=["/sing/index.html","/sing/css/bundle.css","/sing/js/bundle.js"];self.addEventListener("install",function(event){console.log("sing: install");event.waitUntil(caches.open(CACHE_NAME).then(function(cache){return cache.addAll(CACHE)}))});self.addEventListener("fetch",function(event){console.log("sing: fetch");event.respondWith(caches.open(CACHE_NAME).then(function(cache){return cache.match(event.request).then(function(response){return response||fetch(event.request).then(function(response){cache.put(event.request,response.clone());return response})})}))});self.addEventListener("activate",function activator(event){console.log("sing: activate");event.waitUntil(caches.keys().then(function(keys){return Promise.all(keys.filter(function(key){return key.indexOf(CACHE_NAME)!==0}).map(function(key){return caches.delete(key)}))}))});